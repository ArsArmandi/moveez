//waiting for https://dev.azure.com/mseng/AzureDevOpsRoadmap/_workitems/edit/1364226/
variables:
  registryName: 'moveez'
  registryLogin: ''
  registryPassword: ''
  projectName: 'ketchup'

steps:
- task: HelmInstaller@0
  displayName: 'Install Helm 2.13.0'
  inputs:
    helmVersion: 2.13.0
    checkLatestHelmVersion: false

- task: HelmDeploy@0
  displayName: 'helm init'
  inputs:
    azureSubscription: ''
    azureResourceGroup: moveez
    kubernetesCluster: moveez
    command: init
    arguments: '--service-account tiller'

- bash: 'helm repo add $(registryName) https://$(registryName).azurecr.io/helm/v1/repo --username $(registryLogin) --password $(registryPassword)'
  displayName: 'helm repo add'

- task: HelmDeploy@0
  displayName: 'helm upgrade'
  inputs:
    azureSubscription: ''
    azureResourceGroup: moveez
    kubernetesCluster: moveez
    command: upgrade
    chartName: '$(registryName)/$(projectName)_$(Build.SourceBranchName)'
    releaseName: '$(projectName)'
    arguments: '--version $(build.BuildNumber) --set image.repository=$(registryName).azurecr.io/$(projectName) --set image.tag=$(build.BuildNumber)_$(Build.SourceBranchName) --set ingress.enabled=false --set branchName=$(Build.SourceBranchName)  --set stage=$(Release.EnvironmentName)'

- bash: |
   echo "sleep for 20 seconds"
   sleep 20
   echo "curl https://$(projectName)-$(Build.SourceBranchName)-$(Release.EnvironmentName).moveez.de/health -v"
   curl https://$(projectName)-$(Build.SourceBranchName)-$(Release.EnvironmentName).moveez.de/health -v
  displayName: Flightcheck